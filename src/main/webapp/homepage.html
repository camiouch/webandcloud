<html lang="en">
<head>
<meta name="google-signin-scope" content="profile email">
<meta name="google-signin-client_id"
	content="331048952451-9k74vlboc2n4vvh12jkct30fhc2euc85.apps.googleusercontent.com">
<script src="https://apis.google.com/js/platform.js" async defer></script>


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="shortcut icon" href="/ressources/images/logo2.PNG" type="image/x-icon">
	
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
	
<meta name="description" content="TinyGram is light version of Intagram.">

  <title>TinyGram | Sharing beautifull moments</title>


<script defer
	src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>


<script src="https://unpkg.com/mithril/mithril.js"></script>


</head>
<body>

<section class="hero is-light is-medium">
  <!-- Hero head: will stick at the top -->
  <div class="hero-head">
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="homepage.html">
            <img src="/ressources/images/TinyGram2.PNG" alt="Logo"> <span class= "title"> | TinyGram </span>
          </a>
          <div class="field has-addons navbar-item">
		  <div class="control has-icons-left">
		    <input class="input is-rounded is-small" type="text" placeholder="@username">
		     <span class="icon is-small is-left">
		        <i class="fas fa-search fa-xs"></i>
		     </span>
		  </div>
		  <div class="control">
		    <a class="button is-info is-rounded is-small">
		      Search
		    </a>
		  </div>
		</div>
        </div>
        <div id="navbarMenuHeroA" class="navbar-menu">
          <div class="navbar-end">
            
            <span class="navbar-item is-active">
              <a class="button is-info is-inverted" onclick = "m.route.set('/secret')">
                <span class="icon">
                  <i class="fas fa-home"></i>
                </span>
              </a>
            </span>
            <span class="navbar-item">
              <a class="button is-info is-inverted" onclick = "m.route.set('/profile')">
                <span class="icon">
                  <i class="fas fa-user"></i>
                </span>
              </a>
            </span>
            <span class="navbar-item">
              <a class="button is-info is-inverted" onclick = "m.route.set('/post')">
                <span class="icon">
                  <i class="fas fa-camera"></i>
                </span>
              </a>
            </span>
            <span class="navbar-item">
              <a class="button is-info is-inverted" onclick = "m.route.set('/explore')">
                <span class="icon">
                  <i class="fab fa-searchengin"></i>
                </span>
              </a>
            </span>
              
          </div>
        </div>
        
      </div>
    </nav>
  </div>
</section>
<!-- Partie qui sera manipulée par Mithril, le virtual dom -->
<section>
	<div id="vDom"> </div>
</section>
<script>


var HomePageWiew  = {
		view: function() {
			return m('div', {class:'container'}, [
				m('div', m(HomePage)),
		    ])
		}
		
}	

var HomePage={
  name:"",
  email:"",
  ID:"",
  url:"",
  bio:"",
  nextToken:"",
  list:[],
  oncreate: function() {
     console.log("HomePage created")
     setTimeout(() => {
     	 Followers.loadFollowers();
       }, 10);
      
      setTimeout(() => {
     	 Followings.loadFollowings();
       }, 10);
      
      Profile.nbFollowers = Followers.followers.length
      Profile.nbFollowings = Followings.followings.length
  },
  view: function(){
	return m('div', {class:'container'}, [
		m('div',{class: 'columns ',},[
			m('div',{class:'column is-2'},""),
			m('div', {class:'column is-8 has-text-centered'}, [
				m('div', {class:'level'}, [
					 m("h1", {class: 'level-left '}, [
						
						 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
						      console.log('Homepage clicked from Home page');
						      m.route.set("/secret")
					 		}},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-home'}),
							  ]),
						  ]),
						  
						  m("a",{class: 'level-item is-inverted',onclick : function () {
							      console.log('Profile clicked from Home page');
							      
							      m.route.set("/profile")
						 }},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-user'}),
							  ]),
						  ]),
						  
						  m("a",{class: 'level-item is-inverted',onclick : function () {
						      console.log('Post clicked from Post page');
						      m.route.set("/post")
						  }},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-camera'}),
							  ]),
						  ]),
					  ]),
					 m("button", {class: 'button level-right is-link',  onclick : function () {
						    var auth2 = gapi.auth2.getAuthInstance();
						    auth2.signOut().then(function () {
						      console.log('User signed out.');
						      m.route.set("/login")
						    });
					 }}, [
						    m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-sign-out-alt'}),
							  ]),
							  m('strong', " Se Déconnecter"),
						  ]),
				]),		  
		      
		 	  m("div",{class:'box'},[
		 		  m('div',{class: 'card-header is-light'},[
    					m('div',{class: 'card-header-title is-centered '}, "Accueil")
    				]),
    				m('hr'),
		 		  m(ShowPost,{profile: HomePage})
		 		  ]),
		 ]),
		 m('div',{class:'column is-2'},""),
	  ]),  
	])
  },
  loadList: function() {
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/posts/user/timeline"+'?access_token=' + encodeURIComponent(HomePage.ID)
          })
      .then(function(result) {
      	console.log("load_list:",result)
      	HomePage.list=result.items
          if ('nextPageToken' in result) {
	        	HomePage.nextToken= result.nextPageToken
          } else {
          	HomePage.nextToken=""
          }})
  },
  next: function() {
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/posts/user/timeline",
          params: {
        	  'next':HomePage.nextToken,
        	  'access_token': encodeURIComponent(HomePage.ID)
          }
       })
      .then(function(result) {
      	console.log("next:",result)
      	result.items.map(function(item){HomePage.list.push(item)})
          if ('nextPageToken' in result) {
	        	HomePage.nextToken= result.nextPageToken
          } else {
          	HomePage.nextToken=""
          }})
  },
  
  userManager : function() {
	  var data={'profilUrl':HomePage.url,
				'name':HomePage.name}
		   	console.log("post:"+data)
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/users/userManager"+'?access_token='+encodeURIComponent(HomePage.ID),
          params: data,
          })
      .then(function(result) {
      	console.log("user_manager:",result)
      	HomePage.bio = result.properties.bio;
      })
  }
}

//----------------------------------Layout pour afficher une liste de POSTS-------------------------------------//
var ShowPost = {
		oninit: function(vnode) { 
	        console.log("PostShow initialized")
	        vnode.attrs.profile.userManager()
	        vnode.attrs.profile.loadList()     
	    },
	    view: function(vnode) {
	    	var heart_icon_class = [];
			
	    	//Pour precharger la bonne couleur de 'icone du lien du Like
	    	vnode.attrs.profile.list.map(function(item) {
				 if(item.properties.likes){
					 if (item.properties.likes.includes(Profile.email)) {
						 heart_icon_class[item.key.name] = 'fas fa-heart';
					 } else {
						 heart_icon_class[item.key.name]= 'far fa-heart';
					 }
				 }else{
					 heart_icon_class[item.key.name] = 'far fa-heart';
				 }
			 });
	    	return m('div', [ 
		   		  vnode.attrs.profile.list.map(function(item) {
				      return m('div',{class: ''},[ 
			      			m('div',{class: 'card'},[
						    	m('div',{class: 'card-content'},[
								   m('div',{class: 'media'},[
									  m('div',{class: 'media-left'},[
										  m('figure',{class: 'image is-48x48'},[
											  m("img",{class: 'is-rounded',"src": HomePage.url}),	
										  ]),
									  ]),
									  m('div',{class: 'media-content'},[
										  m("p", {class: 'subtitle is-6'},[
											  m('strong',{class:''},""+item.properties.owner.split("@",1)), 
										  ]), 
										  m('p',{class:'is-7'  }, [
											  m("span", {class: '', style :"color : #4072e6"},
												"Publié le : "+new Date(item.properties.date).toLocaleString("fr-FR")) // TO DO : pour Liker	
										  ]),
								   	  ]),
								   ]),
								]),  
						        m('div',{class: 'card-image'},[
									m('figure',{class: 'image is-3by2', "alt" : "POST URL"},[
										 m("img",{class: '',"src": item.properties.url}),
										 
									 ]),
								]),
								m('div',{class: 'card-content'},[
									m('nav',{class: 'level is-mobile'},[
									  m("div",{class: 'level-left'},[
										  m('div',{class:'level-item '  }, [
											  m("button", {class: 'button is-primary', id: item.key.name,
												  onclick: function() { likeClickListner(item.key.name) }
												}, "Liker") // TO DO : pour Liker	
										  ]),
										  m('div',{class:'level-item '  }, [
											  m("button", {class: 'button is-danger', id: item.key.name+"sup",
												  onclick: function() { deletePost(item.key.name) }
												}, "Supprimer") // TO DO : pour supprimer	
										  ]),
									  ]), 	  
								  ]),  				 	 
								       	  
						  	  ]),
						  	  
						  	  m('footer',{class: 'card-footer'},[ 
						  		 m("p", {class: 'card-footer-item'},[
						  			 m('nav',{class: 'level is-mobile'},[
										  m("div",{class: 'level-left'},[
											  m('p',{class:' level-item'}, [
												  m('span',{class:'icon is-small'}, [
													  m('i',{class:'fas fa-heart'}), 
												  ]),
												  m('strong',{id: item.key.name+"like"}, item.properties.likec+" Likes"),
											  ]),
										  ]), 	  
									  ]),  
								 ]), 
								 m("p", {class: 'card-footer-item'},[
						  			 m('nav',{class: 'level is-mobile'},[
										  m("div",{class: 'level-left'},[
											  m('p',{class:' level-item'}, [
												  m('span',[
													 	 m('strong',{class:''},""+item.properties.owner.split("@",1)), 
												 	 ], " "+item.properties.body),
											  ])
										  ]) 	  
									  ])  
								 ]) 
						  	  ])
						  	  
						    ]),
						    m('hr')
		])				    
	  }),
	    m('button',{
		      class: 'button is-link',
		      onclick: function(e) {vnode.attrs.profile.next()}
		 },
	   "Next"),
     ])
  }
}
//-----------------------------------------------------------------------------------------------------------//

//----------------------------------Formulaire POST-------------------------------------//
var PostForm = {
		url:"",
		body:"",
		  view: function() {
		    return m('div',{class:'container '},[
		    	m('div', {class:'panel'},[
		    		m("h2", {class: 'panel-heading'}, 'Nouvelle Publication'),
			    m("form", {
			      onsubmit: function(e) {
			        e.preventDefault()
					if (PostForm.url=="") {PostForm.url="https://dummyimage.com/320x200/000/fff&text"} 
					if (PostForm.body=="") {PostForm.body="post-body \n"+Date.now()}
			        Post.postMessage()
			      }},[
		       
			      m('div', {class:'field panel-block is-horizontal'},[
			         m("label", {class:'label field-label'},"URL"),
			         m('div',{class:'control'}, m("input[type=text]", {
			          class:'input is-rounded',
			          placeholder:"Your image url",
			             oninput: function(e) {PostForm.url = e.target.value}})),
	//		         m("img",{"src":this.url}),
			      ]),
			      m('div',{class:'field panel-block is-horizontal'},[
			    	  m("label", {class: 'label field-label'},"Body"),
			          m('div',{class:'control '},m("input[type=textarea]", {
			        class:'textarea',
			        placeholder:"your comments",
			        oninput: function(e) { PostForm.body = e.target.value }})),
			        ]),
			      m('div',{class:'field is-grouped is-grouped-right'},[
				      m('div',{class:'control'},m("button[type=submit]", {class:'button is-primary'},"Poster")),
				      m('div',{class:'control'},m("button[type=reset]", {class:'button is-light'},"Annuler")),
			     ])
		       ])
		     ])
		   ])
		  }
		}
//---------------------------------------------------------------------------------------------------//
//------------------------------------------Page du formuaire d'un post---------------------------------------------------------//
var Post = {
		view: function() {
		 	return m('section', {class:'hero is-white is-medium'}, [
		 		m('div', {class:'hero-body'}, [
		 			m('div', {class:'container'}, [
				 		m('div',{class: 'columns ',},[		 					 
				 			m('div',{class:'column is-2'},""),
							m('div', {class:'column is-8'}, [
								m('div', {class:'level'}, [
									 m("h1", {class: 'level-left '}, [
										 
										 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
										      console.log('Homepage clicked from Post page');
										      m.route.set("/secret")
									 		}},[
											  m('span', {class:'icon'}, [
												  m('i',{class:'fas fa-home'}),
											  ]),
										  ]),
										  
										  m("a",{class: 'level-item is-inverted',onclick : function () {
											      console.log('Profile clicked from Post page');
											      m.route.set("/profile")
										  }},[
											  m('span', {class:'icon'}, [
												  m('i',{class:'fas fa-user'}),
											  ]),
										  ]),
										  
										  m("a",{class: 'level-item is-inverted',onclick : function () {
										      console.log('Post clicked from Post page');
										      m.route.set("/post")
										  }},[
											  m('span', {class:'icon'}, [
												  m('i',{class:'fas fa-camera'}),
											  ]),
										  ]),
										  
									  ]),
									 m("button", {class: 'button level-right is-link',  onclick : function() {
										    var auth2 = gapi.auth2.getAuthInstance();
										    auth2.signOut().then(function () {
										      console.log('User signed out.');
										      m.route.set("/login")
										    });
									 }}, [
										    m('span', {class:'icon'}, [
												  m('i',{class:'fas fa-sign-out-alt'}),
											  ]),
											  m('strong', " Se Déconnecter"),
										  ]),
								]),		  
						      
						 	  m("div",{class:'box'},m(PostForm)),
							 ]),
							 m('div',{class:'column is-2'},""),			     
				 		 ]),
		 		       ]),  
		 	        ]),
		        ])
		    },
		  postMessage: function() {
			var data={'url':PostForm.url,
				'body':PostForm.body}
		   	console.log("post:"+data)
			return m.request({
		   		method: "POST",
		   		url: "_ah/api/myApi/v1/posts/new"+'?access_token='+encodeURIComponent(HomePage.ID),
		       	params: data,
		   	})
		    	.then(function(result) {
		 			console.log("post_message: ",result)
		 			m.route.set("/secret")
		   	 	})
		  }
}
//---------------------------------------------------------------------------------------------------//

//---------------------------------------------------Page du profil---------------------------------------------------//  
var ProfileView  = {
		view: function() {
			return m('div', {class:'container'}, [
				m('div', m(Profile)),
		    ])
		}
		
}	

var Profile={
  name:"",
  email:"",
  ID:"",
  url:"",
  bio:"",
  nbFollowers : "",
  nbFollowings : "",
  nextToken:"",
  list:[], //liste de ses posts
  
  oncreate: function() {
     console.log("Profile created")
    
  },
  oninit: function() {
	  
	     setTimeout(() => {
	    	 Followers.loadFollowers;
          }, 10);
	     
	     setTimeout(() => {
	    	 Followings.loadFollowings;
          }, 10);
	     
	     Profile.nbFollowers = Followers.followers.length
	     Profile.nbFollowings = Followings.followings.length
	    
	  },
  view: function(){
	return m('div', {class:'container'}, [
		m('div',{class: 'columns ',},[
			m('div',{class:'column is-2'},""),
			m('div', {class:'column is-8 has-text-centered'}, [
				m('div', {class:'level'}, [
					 m("h1", {class: 'level-left '}, [
						
						 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
						      console.log('Homepage clic');
						      m.route.set("/secret")
					 		}},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-home'}),
							  ]),
						  ]),
						  
						  m("a",{class: 'level-item is-inverted is-active',onclick : function (){
							    
							      console.log('Profil link is clicked.');
							     
							      m.route.set("/profile")
							    
							 }},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-user'}),
							  ]),
						  ]),
						  
						  m("a",{class: 'level-item is-inverted',onclick : function () {
						      console.log('Post clicked from Post page');
						      m.route.set("/post")
						  }},[
							  m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-camera'}),
							  ]),
						  ]),
					  ]),
					 m("button", {class: 'button level-right is-link',  onclick : function () {
						    var auth2 = gapi.auth2.getAuthInstance();
						    auth2.signOut().then(function () {
						      console.log('User signed out.');
						      m.route.set("/login")
						    });
					 }}, [
						    m('span', {class:'icon'}, [
								  m('i',{class:'fas fa-sign-out-alt'}),
							  ]),
							  m('strong', " Se Déconnecter"),
						  ]),
				]),
			 
			  
			   m('div',{class: 'card'},[
				   m('div',{class: 'card-header is-light'},[
     					m('div',{class: 'card-header-title is-centered '}, "Profil")
     				]),
				    m('div',{class: 'card-content'},[
					   m('div',{class: 'media'},[
						  m('div',{class: 'media-left'},[
							  m('figure',{class: 'image is-128x128'},[
								  m("img",{class: 'is-rounded',"src":Profile.url}),	
							  ]),
						  ]),
						  m('div',{class: 'media-content'},[
							  m("p", {class: 'title is-4'}, Profile.name),
							  m("p", {class: 'subtitle is-6'}, "@"+Profile.email.split("@",1)),
							  m('nav',{class: 'level-left'},[
								  m("p",{class: 'level-item'},[
									  m('a',{class:' is-link', onclick : function () {
									      console.log('Posts clicked from Profil page');
									     
									      m.route.set("/profile")
									  }}, [
										  m('strong',{class:''}, Profile.list.length), //TO DO : nb de posts
									  ], " publications"),
								  ]),
									  
								  m("p",{class: 'level-item'},[
									  m('a',{class:' is-link', onclick : function () {
									      console.log('Followers clicked from Profil page yess');
									     
									      m.route.set("/followers")
									  }}, [
										  m('strong',{class:''}, Profile.nbFollowers), //TO DO : nb de followers
									  ], " abonnés"),
								  ]),
								  
								  m("p",{class: 'level-item'},[
									  m('a',{class:' is-link', onclick : function () {
									      console.log('Followings clicked from Profil page');
									      
									      m.route.set("/followings")
									  }}, [
										  m('strong',{class:''}, Profile.nbFollowings), //TO DO : nb de followings
									  ], " abonnements"),
								  ]),
									  
							   ]),  
							      
							   m("p", {class: 'is-4'},[ 
								   m('strong',{class:''},""+Profile.email.split("@",1)),
								]), 
							   m('p',{class:''}, Profile.bio),
					   		]),
					    ]),
					]),  
		      ]),  
		      
		 	  m("div",{class:'box'},m(ShowPost,{profile: Profile})),
		 ]),
		 m('div',{class:'column is-2'},""),
	  ]),  
	])
  },
  loadList: function() {
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/posts/owner"+'?access_token=' + encodeURIComponent(Profile.ID)
          })
      .then(function(result) {
      	console.log("load_list profile:",result)
      	Profile.list=result.items
          if ('nextPageToken' in result) {
	        	Profile.nextToken= result.nextPageToken
          } else {
          	Profile.nextToken=""
          }})
  },
  next: function() {
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/posts/owner",
          params: {
        	  'next':Profile.nextToken,
        	  'access_token': encodeURIComponent(Profile.ID)
          }
       })
      .then(function(result) {
      	console.log("next:",result)
      	result.items.map(function(item){Profile.list.push(item)})
          if ('nextPageToken' in result) {
	        	Profile.nextToken= result.nextPageToken
          } else {
          	Profile.nextToken=""
          }})
  },
  
  userManager : function() {
	  var data={'profilUrl':Profile.url,
				'name':Profile.name}
		   	console.log("post:"+data)
      return m.request({
          method: "GET",
          url: "_ah/api/myApi/v1/users/userManager"+'?access_token='+encodeURIComponent(Profile.ID),
          params: data,
          })
      .then(function(result) {
      	console.log("user_manager:",result)
      	Profile.bio = result.properties.bio;
      })
  },
  
}

//----------------------------------------------------------------------------------------//


//--------------------------------------------------Page des followers---------------------------------------------------//  
var FollowersView  = {
		view: function() {
			return m('div', {class:'container'}, [
				m('div', m(Followers)),
		    ])
		}
		
}
var ShowFollowers =	{
		
		
		oninit: function(vnode) { 
			
			vnode.attrs.profile.loadFollowers()      
	        console.log("Followers initialized")	     
	    },
	    view: function(vnode) {
		    	return m('div', [ 
		   		  vnode.attrs.profile.followers.map(function(item) {
				      return m('div',{class: ''},[ 
			      			m('div',{class: 'card'},[
			      				
						    	m('div',{class: 'card-content'},[
								   m('div',{class: 'media'},[
			
									  m('div',{class: 'media-content'},[
										  m("p", {class: 'title is-4'}, item.split("@",1)),
										 
										  m("p", {class: 'subtitle is-4'},[
											  m('span',{class:''},""+item), 
										  ]), 
										  
										  m('p',{class:''}, " Vous suit"),										  
								   	  ]),
								   	  
								   	 m('div',{class: 'media-right'},[
										  m("button", {class: 'button is-primary', id: item,
											  onclick: function() { followClickListner(item) }
											}, "S'abonner") // TO DO : pour follow										  
											  
								   	  ]),
								   	  
								   ]),
								]),  					      
						  	  
						    ]),
						    m('hr')
		])				    
	  }),
	    m('button',{
		      class: 'button is-link',
		      onclick: function(e) {vnode.attrs.profile.nextFollowers()}
		 },
	   "Next "),
     ])
  }		              
	    	  
}

var Followers = {
		  
		  nextToken:"",
		  followers:[], //abonnés
		  oncreate: function() {
		     console.log("Followers created")
		  },
		  view: function(){
			return m('div', {class:'container'}, [
				m('div',{class: 'columns ',},[
					m('div',{class:'column is-2'},""),
					m('div', {class:'column is-8 has-text-centered'}, [
						m('div', {class:'level'}, [
							 m("h1", {class: 'level-left '}, [
								
								 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
								      console.log('Homepage clicked from Profil page');
								      m.route.set("/secret")
							 		}},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-home'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted is-active',onclick : function (){
									    
									      console.log('Profil link is clicked.');
									   
									      m.route.set("/profile")
									    
									 }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-user'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted',onclick : function () {
								      console.log('Post clicked from Post page');
								      m.route.set("/post")
								  }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-camera'}),
									  ]),
								  ]),
							  ]),
							 m("button", {class: 'button level-right is-link',  onclick : function () {
								    var auth2 = gapi.auth2.getAuthInstance();
								    auth2.signOut().then(function () {
								      console.log('User signed out.');
								      m.route.set("/login")
								    });
							 }}, [
								    m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-sign-out-alt'}),
									  ]),
									  m('strong', " Se Déconnecter"),
								  ]),
						]),
					 
					  
					   m('div',{class: 'card'},[
						   m('div',{class: 'card-header is-light'},[
		      					m('div',{class: 'card-header-title is-centered '}, "Abonnés")
		      				]),
						    m('div',{class: 'card-content'},[
							   m('div',{class: 'media'},[
								  m('div',{class: 'media-left'},[
									  m('figure',{class: 'image is-128x128'},[
										  m("img",{class: 'is-rounded',"src":Profile.url}),	
									  ]),
								  ]),
								  m('div',{class: 'media-content'},[
									  m("p", {class: 'title is-4'}, Profile.name),
									  m("p", {class: 'subtitle is-6'}, "@"+Profile.email.split("@",1)),
									  m('nav',{class: 'level-left'},[
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Posts clicked from Profil page');
											     
											      m.route.set("/profile")
											  }}, [
												  m('strong',{class:''}, Profile.list.length), //TO DO : nb de posts
											  ], " publications"),
										  ]),
											  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followers clicked from Profil page yess');
											     
											      m.route.set("/followers")
											  }}, [
												  m('strong',{class:''},Followers.followers.length), //TO DO : nb de followers
											  ], " abonnés"),
										  ]),
										  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followings clicked from Profil page');
											     
											      m.route.set("/followings")
											  }}, [
												  m('strong',{class:''},Followings.followings.length), //TO DO : nb de followings
											  ], " abonnements"),
										  ]),
											  
									   ]),  
									      
									   m("p", {class: 'is-4'},[ 
										   m('strong',{class:''},""+Profile.email.split("@",1)),
										]), 
									   m('p',{class:''}, Profile.bio),
							   		]),
							    ]),
							]),  
				      ]),  
				      
				 	  m("div",{class:'box'},m(ShowFollowers,{profile: Followers})),
				 ]),
				 m('div',{class:'column is-2'},""),
			  ]),  
			])
		  },
		  		 		  
		  loadFollowers: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/followers"+'?access_token=' + encodeURIComponent(Profile.ID)
		          })
		      .then(function(result) {
		      	console.log("load followers:",result)
		      	Followers.followers=result.items
		          if ('nextPageToken' in result) {
		        	  Followers.nextToken= result.nextPageToken
		          } else {
		        	  Followers.nextToken=""
		          }})
		  },
		  nextFollowers: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/followers",
		          params: {
		        	  'next':Followers.nextToken,
		        	  'access_token': encodeURIComponent(Profile.ID)
		          }
		       })
		      .then(function(result) {
		      	console.log("next followers:",result)
		      	result.items.map(function(item){Followers.followers.push(item)})
		      	
		          if ('nextPageToken' in result) {
		        	  Followers.nextToken= result.nextPageToken
		          } else {
		        	  Followers.nextToken=""
		          }})
		  }
}
//------------------------------------------------------------------------------------------------------//

//---------------------------------------------------Page des followings---------------------------------------------------//  
var FollowingsView  = {
		view: function() {
			return m('div', {class:'container'}, [
				m('div', m(Followings)),
		    ])
		}
		
}
var ShowFollowings =	{
		
		
		oninit: function(vnode) { 
			
			vnode.attrs.profile.loadFollowings()      
	        console.log("Followings initialized")
	     
	    },
	    view: function(vnode) {
		    	return m('div', [ 
		   		  vnode.attrs.profile.followings.map(function(item) {
				      return m('div',{class: ''},[ 
			      			m('div',{class: 'card'},[
						    	m('div',{class: 'card-content'},[
								   m('div',{class: 'media'},[
									   m('div',{class: 'media-content'},[
											  m("p", {class: 'title is-4'}, item.split("@",1)),
											 
											  m("p", {class: 'subtitle is-4'},[
												  m('span',{class:''},""+item), 
											  ]), 
											  
											  m('p',{class:''}, " Vous suivez"),										  
									   	  ]),
								   	  
								   	 m('div',{class: 'media-right'},[
										  m("button", {class: 'button is-danger', id: item,
											  onclick: function() { followClickListner(item) }
											  }, "Se Désabonner") // TO DO : à completer pour le unfollow									  
								   	  ]),
								   	  
								   ]),
								]),  					      
						  	  
						    ]),
						    m('hr')
		])				    
	  }),
	    m('button',{
		      class: 'button is-link',
		      onclick: function(e) {vnode.attrs.profile.nextFollowings()}
		 },
	   "Next "),
     ])
  }		              
	    	  
}

var Followings = {
		  
		  nextToken:"",
		  followings:[], //abonnés
		  oncreate: function() {
		     console.log("Followings created")
		  },
		  view: function(){
			return m('div', {class:'container'}, [
				m('div',{class: 'columns ',},[
					m('div',{class:'column is-2'},""),
					m('div', {class:'column is-8 has-text-centered'}, [
						m('div', {class:'level'}, [
							 m("h1", {class: 'level-left '}, [
								
								 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
								      console.log('Homepage clicked from Profil page');
								      m.route.set("/secret")
							 		}},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-home'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted is-active',onclick : function (){
									    
									      console.log('Profil link is clicked.');
									   
									      m.route.set("/profile")
									    
									 }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-user'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted',onclick : function () {
								      console.log('Post clicked from Post page');
								      m.route.set("/post")
								  }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-camera'}),
									  ]),
								  ]),
							  ]),
							 m("button", {class: 'button level-right is-link',  onclick : function () {
								    var auth2 = gapi.auth2.getAuthInstance();
								    auth2.signOut().then(function () {
								      console.log('User signed out.');
								      m.route.set("/login")
								    });
							 }}, [
								    m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-sign-out-alt'}),
									  ]),
									  m('strong', " Se Déconnecter"),
								  ]),
						]),
					 
					  
					   m('div',{class: 'card'},[
						   m('div',{class: 'card-header is-light'},[
		      					m('div',{class: 'card-header-title is-centered '}, "Abonnements")
		      				]),
						    m('div',{class: 'card-content'},[
							   m('div',{class: 'media'},[
								  m('div',{class: 'media-left'},[
									  m('figure',{class: 'image is-128x128'},[
										  m("img",{class: 'is-rounded',"src":Profile.url}),	
									  ]),
								  ]),
								  m('div',{class: 'media-content'},[
									  m("p", {class: 'title is-4'}, Profile.name),
									  m("p", {class: 'subtitle is-6'}, "@"+Profile.email.split("@",1)),
									  m('nav',{class: 'level-left'},[
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Posts clicked from Profil page');
											     
											      m.route.set("/profile")
											  }}, [
												  m('strong',{class:''}, Profile.list.length), //TO DO : nb de posts
											  ], " publications"),
										  ]),
											  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followers clicked from Profil page yess');
											     
											      m.route.set("/followers")
											  }}, [
												  m('strong',{class:''}, Followers.followers.length), //TO DO : nb de followers
											  ], " abonnés"),
										  ]),
										  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followings clicked from Profil page');
											     
											      m.route.set("/followings")
											  }}, [
												  m('strong',{class:''},Followings.followings.length), //TO DO : nb de followings
											  ], "abonnements"),
										  ]),
											  
									   ]),  
									      
									   m("p", {class: 'is-4'},[ 
										   m('strong',{class:''},""+Profile.email.split("@",1)),
										]), 
									   m('p',{class:''}, Profile.bio),
							   		]),
							    ]),
							]),  
				      ]),  
				      
				 	  m("div",{class:'box'},m(ShowFollowings,{profile: Followings})),
				 ]),
				 m('div',{class:'column is-2'},""),
			  ]),  
			])
		  },
		  		 		  
		  loadFollowings: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/followings"+'?access_token=' + encodeURIComponent(Profile.ID)
		          })
		      .then(function(result) {
		      	console.log("load followings:",result)
		      	Followings.followings=result.items
		          if ('nextPageToken' in result) {
		        	  Followings.nextToken= result.nextPageToken
		          } else {
		        	  Followings.nextToken=""
		          }})
		  },
		  nextFollowings: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/followings",
		          params: {
		        	  'next':Followings.nextToken,
		        	  'access_token': encodeURIComponent(Profile.ID)
		          }
		       })
		      .then(function(result) {
		      	console.log("next followings:",result)
		      	result.items.map(function(item){Followings.followings.push(item)})
		          if ('nextPageToken' in result) {
		        	  Followings.nextToken= result.nextPageToken
		          } else {
		        	  Followings.nextToken=""
		          }})
		  }
}
//---------------------------------------------------------------------------------------------------------//
//---------------------------------------------------Page de l'exploration---------------------------------------------------//  
var ExploreView  = {
		view: function() {
			return m('div', {class:'container'}, [
				m('div', m(Explore)),
		    ])
		}
		
}
var ShowExplore =	{
		
		
		oninit: function(vnode) { 
			
			vnode.attrs.profile.loadExplore()      
	        console.log("Explore initialized")
	     
	    },
	    view: function(vnode) {
		    	return m('div', [ 
		   		  vnode.attrs.profile.exploreList.map(function(item) {
				      return m('div',{class: ''},[ 
			      			m('div',{class: 'card'},[
						    	m('div',{class: 'card-content'},[
								   m('div',{class: 'media'},[
									  m('div',{class: 'media-left'},[
										  m('figure',{class: 'image is-48x48'},[
											  m("img",{class: 'is-rounded',"src": item.properties.profilUrl}),	
										  ]),
									  ]),
									  m('div',{class: 'media-content'},[
										  m("p", {class: 'title is-4'}, item.properties.name),
										  m("p", {class: 'is-4'},[
											  m('strong',{class:''},""+item.properties.pseudo), 
										  ]), 
										  
										  m('p',{class:''}, item.properties.bio),										  
								   	  ]),
								   	  
								   	 m('div',{class: 'media-right'},[
										  m("button", {class: 'button is-primary', id: item.key.name,
											  onclick: function() { followClickListner(item.key.name) }
											  }, "S'abonner") // TO DO : à completer pour le follow									  
								   	  ]),
								   	  
								   ]),
								]),  					      
						  	  
						    ]),
						    m('hr')
		])				    
	  }),
	    m('button',{
		      class: 'button is-link',
		      onclick: function(e) {vnode.attrs.profile.nextExplore()}
		 },
	   "Next "),
     ])
  }		              
	    	  
}

var Explore = {
		  
		  nextToken:"",
		  exploreList:[], //abonnés
		  oncreate: function() {
		     console.log("Explore created")
		  },
		  view: function(){
			return m('div', {class:'container'}, [
				m('div',{class: 'columns ',},[
					m('div',{class:'column is-2'},""),
					m('div', {class:'column is-8 has-text-centered'}, [
						m('div', {class:'level'}, [
							 m("h1", {class: 'level-left '}, [
								
								 m("a",{class: 'level-item is-inverted is-active', onclick : function () {
								      console.log('Homepage clicked from Profil page');
								      m.route.set("/secret")
							 		}},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-home'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted is-active',onclick : function (){
									    
									      console.log('Profil link is clicked.');
									   
									      m.route.set("/profile")
									    
									 }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-user'}),
									  ]),
								  ]),
								  
								  m("a",{class: 'level-item is-inverted',onclick : function () {
								      console.log('Post clicked from Post page');
								      m.route.set("/post")
								  }},[
									  m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-camera'}),
									  ]),
								  ]),
							  ]),
							 m("button", {class: 'button level-right is-link',  onclick : function () {
								    var auth2 = gapi.auth2.getAuthInstance();
								    auth2.signOut().then(function () {
								      console.log('User signed out.');
								      m.route.set("/login")
								    });
							 }}, [
								    m('span', {class:'icon'}, [
										  m('i',{class:'fas fa-sign-out-alt'}),
									  ]),
									  m('strong', " Se Déconnecter"),
								  ]),
						]),
					 
					  
					   m('div',{class: 'card'},[
						   m('div',{class: 'card-header is-light'},[
		      					m('div',{class: 'card-header-title is-centered '}, "Explorer")
		      				]),
						    m('div',{class: 'card-content'},[
							   m('div',{class: 'media'},[
								  m('div',{class: 'media-left'},[
									  m('figure',{class: 'image is-128x128'},[
										  m("img",{class: 'is-rounded',"src":Profile.url}),	
									  ]),
								  ]),
								  m('div',{class: 'media-content'},[
									  m("p", {class: 'title is-4'}, Profile.name),
									  m("p", {class: 'subtitle is-6'}, "@"+Profile.email.split("@",1)),
									  m('nav',{class: 'level-left'},[
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Posts clicked from Profil page');
											     
											      m.route.set("/profile")
											  }}, [
												  m('strong',{class:''}, Profile.list.length), //TO DO : nb de posts
											  ], " publications"),
										  ]),
											  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followers clicked from Profil page yess');
											     
											      m.route.set("/followers")
											  }}, [
												  m('strong',{class:''}, Profile.nbFollowers), //TO DO : nb de followers
											  ], " abonnés"),
										  ]),
										  
										  m("p",{class: 'level-item'},[
											  m('a',{class:' is-link', onclick : function () {
											      console.log('Followings clicked from Profil page');
											     
											      m.route.set("/followings")
											  }}, [
												  m('strong',{class:''}, Profile.nbFollowers), //TO DO : nb de followings
											  ], "abonnements"),
										  ]),
											  
									   ]),  
									      
									   m("p", {class: 'is-4'},[ 
										   m('strong',{class:''},""+Profile.email.split("@",1)),
										]), 
									   m('p',{class:''}, Profile.bio),
							   		]),
							    ]),
							]),  
				      ]),  
				      
				 	  m("div",{class:'box'},m(ShowExplore,{profile: Explore})),
				 ]),
				 m('div',{class:'column is-2'},""),
			  ]),  
			])
		  },
		  		 		  
		  loadExplore: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/explore"+'?access_token=' + encodeURIComponent(Profile.ID)
		          })
		      .then(function(result) {
		      	console.log("load Explore:",result)
		      	Explore.exploreList=result.items
		          if ('nextPageToken' in result) {
		        	  Explore.nextToken= result.nextPageToken
		          } else {
		        	  Explore.nextToken=""
		          }})
		  },
		  nextFollowings: function() {
		      return m.request({
		          method: "GET",
		          url: "_ah/api/myApi/v1/users/explore",
		          params: {
		        	  'next':Explore.nextToken,
		        	  'access_token': encodeURIComponent(Profile.ID)
		          }
		       })
		      .then(function(result) {
		      	console.log("next followings:",result)
		      	result.items.map(function(item){Explore.exploreList.push(item)})
		          if ('nextPageToken' in result) {
		        	  FollowExploreings.nextToken= result.nextPageToken
		          } else {
		        	  Explore.nextToken=""
		          }})
		  }
}
//---------------------------------------------------------------------------------------------------------//
//----------------------fonction de google login---------------------------------------------------//
function onSignIn(googleUser) {
  var profile = googleUser.getBasicProfile();
  HomePage.name=profile.getName();
  HomePage.email=profile.getEmail();
  HomePage.ID=googleUser.getAuthResponse().id_token;
  HomePage.url=profile.getImageUrl();
  
  Profile.name=profile.getName();
  Profile.email=profile.getEmail();
  Profile.ID=googleUser.getAuthResponse().id_token;
  Profile.url=profile.getImageUrl();
  
 
  
  m.route.set("/secret")
}
//-----------------------------------------------------------------------------------------------------------------------//


//---------------------------------------------------Page du LOGIN---------------------------------------------------//
var Login = {
  view: function() {
 	return m('section', {class:'hero is-white  is-medium'}, [
 		m('div', {class:'hero-body'}, [
 			m('div', {class:'container'}, [
		 		m('div',{class: 'columns ',},[		 					 
					  m('div',{class:'column is-one-quarter'},""),
					  m('article',{class: ' panel is-link column is-4 has-text-centered'},[	
						     m('p',{class:'panel-heading'},"Bienvenue sur TinyGram"),
						     m('p',{class:'subtitle is-light'},"Connectez-vous avec votre compte Google"),	 
						 	 m('div',{class: 'columns '},[
						 		  m('div',{class:'column is-one-quarter'},""),
								  m("div", {
							      	   "class":"g-signin2 column is-2",
							      	   "data-theme":"dark",
							      	   "data-onsuccess": "onSignIn"}),
							      ])    
						]),   			     
		 		 ]),
 		       ]),  
 	        ]),
        ])
    }
}


//---------------------------------------------------Chargement du bloc vDom - Routage ---------------------------------------------------//
m.route(document.getElementById("vDom"), "/secret", {
  "/secret": { onmatch: function() {
            	if (HomePage.ID=="") {m.route.set("/login")}
            	else {
            		viewToDisplay = "Home"
            		return HomePageWiew
            	}
        		}},
  "/login": Login,
  "/profile":{ onmatch: function() {
			  	if (Profile.ID=="") {m.route.set("/login")}
				else {
					viewToDisplay = "Profile"
					return ProfileView
				}
			   }},
   "/post":{ onmatch: function() {
			  	if (HomePage.ID=="") {m.route.set("/login")}
				else return Post
	         }},
  "/followers" : { onmatch: function() {
   			  	if (Profile.ID=="") {m.route.set("/login")}
				else return FollowersView
			 }},
   "/followings" : { onmatch: function() {
   			  	if (Profile.ID=="") {m.route.set("/login")}
			    else return FollowingsView
		    }},
    "/explore" : { onmatch: function() {
 			  	if (Profile.ID=="") {m.route.set("/login")}
	    else return ExploreView
    }},
})




//----------------------------------Fonctions utilitaires----------------------------------------// 

//--------------------------like/unlike-------------------------------------------//
function setupLikes(id) {
	
	if (document.getElementById(id) != null) {
		var elem = document.getElementById(id); 			
		var data = {'ID': id}	    	     		
		m.request({
	       		method: "PUT",
	       		url: "_ah/api/myApi/v1/posts/like"+'?access_token='+encodeURIComponent(HomePage.ID),
	              params: data,
	       	}).then(function(result) {
	       		console.log('like setup res : ', result);
	       		document.getElementById(id+"like").innerHTML = result.properties.likec+" Likes"      		
	       		elem.classList.add("is-danger");
	       		elem.classList.remove("is-primary");
	       		elem.innerHTML = "Unliker";
	
	       	 });
		
	} else {
		//setTimeout(setupLikes(id), 800);
		console.log('Like setup else id : ', id);
	}
	
}

function setupUnlikes(id) {
	
	if (document.getElementById(id) != null) {
		var elem = document.getElementById(id); 			
		var data = {'ID': id}	    	     		
		m.request({
	       		method: "PUT",
	       		url: "_ah/api/myApi/v1/posts/unlike"+'?access_token='+encodeURIComponent(HomePage.ID),
	              params: data,
	       	}).then(function(result) {
	       		
	       		console.log('unike setup res : ', result);
	       		elem.classList.add("is-primary");
	       		elem.classList.remove("is-danger");
	       		elem.innerHTML = "Liker";
	       		var res = result
	       		document.getElementById(id+"like").innerHTML = result.properties.likec+" Likes"
	       		/* if(viewToDisplay=="Home") {
	       			m.route.set("/secret")
	       			console.log('home redirect : ', viewToDisplay);
	       		}else {
	       			console.log('profile : ', viewToDisplay);
	       			m.route.set("/profile")
	       		} */
	       		
	       	 });
		
	} else {
		//setTimeout(setupLikes(id), 800);
		console.log('Unlike setup else id : ', id);
	}
	
}
function likeClickListner(id) {
	if (document.getElementById(id) != null) {
		
		var elem = document.getElementById(id);
	    	     			
   		console.log('likeClickListner call : ', elem);
   		
   		  if(elem.innerHTML=="Liker") {
   			  setupLikes(id);
   		  }else{
   			  setupUnlikes(id);
   		  }
   		}
     	
	}
//Paramètre pour différencier home et profile pour l'affichage des postes
var viewToDisplay ="";
//--------------------------follow/unfollow-------------------------------------------//
function setupFollow(id) {
	
	if (document.getElementById(id) != null) {
		    var elem = document.getElementById(id);			
			var data = {"email": id}
 	    	     		
			m.request({
         		method: "PUT",
         		url: "_ah/api/myApi/v1/users/follow"+'?access_token='+encodeURIComponent(HomePage.ID),
                params: data,
         	}).then(function(result) {
         		console.log('follow setup res : ', result);
         		elem.classList.add("is-danger");
         		elem.classList.remove("is-primary");
         		elem.innerHTML = "Se Désabonner";
         	 });
		
	} else {
		//setTimeout(setupFollow(id), 800);
		console.log('follow setup else id : ', id);
	} 
	
}


function setupUnfollow(id) {
	
	if (document.getElementById(id) != null) {
		    var elem = document.getElementById(id);					
			var data = {'email': id}
 	    	     		
			m.request({
         		method: "PUT",
         		url: "_ah/api/myApi/v1/users/unfollow"+'?access_token='+encodeURIComponent(HomePage.ID),
                params: data,
         	}).then(function(result) {
         		console.log('unfollow setup res : ', result);
         		elem.classList.remove("is-danger");
         		elem.classList.add("is-primary");
         		elem.innerHTML = "S'abonner";
         	 });
		
	} else {
		//setTimeout(setupUnfollow(id), 800);
		console.log('unfollow setup else id : ', id);
	} 
	
}

function followClickListner(id) {
	if (document.getElementById(id) != null) {
		
		var elem = document.getElementById(id);
	    	     			
   		console.log('followClickListner call : ', elem);
   		
   		  if(elem.innerHTML=="S'abonner") {
   			  setupFollow(id);
   		  }else{
   			  setupUnfollow(id);
   		  }
   		}
     	
	}

function deletePost(id) {
	
	if (document.getElementById(id) != null) {
		 var elem = document.getElementById(id);	
	   if(viewToDisplay=="Profile") {
		   				
			var data = {'ID': id}
 	    	     		
			m.request({
         		method: "DELETE",
         		url: "_ah/api/myApi/v1/posts/delete"+'?access_token='+encodeURIComponent(HomePage.ID),
                params: data,
         	}).then(function(result) {
         		console.log('delete setup res : ', result);
         		elem.style.visibility = "visible";
         		m.route.set("/profile")
         	 });
	   }else {
		   elem.style.visibility = "hidden";
	   }
		
	} else {
		//setTimeout(setupUnfollow(id), 800);
		console.log('delete setup else id : ', id);
	} 
	
}
//----------------------------------------------------------------------------------------------------// 

		
</script>
	
<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>
        <strong>TinyGram</strong> by <a href="#">Amadou BAH - Elysée NONNONHOU - Vanessa KAMGUE</a>. The source code is licensed
        <a href="http://opensource.org/licenses/mit-license.php">MIT</a> and it is availlable on  
        <a href="https://github.com/Danpitamaci/webandcloud.git">GitHub</a>.
      </p>
    </div>
  </div>
</footer>
</body>
</html>


